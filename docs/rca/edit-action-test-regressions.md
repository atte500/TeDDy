# RCA: Regressions in `edit` Action Acceptance Tests

## 1. Summary
Following a refactoring of the `LocalFileSystemAdapter`, two acceptance tests in `tests/acceptance/test_edit_action.py` began to fail consistently:
1.  `test_multiline_edit_preserves_indentation`: The target file remained unchanged, indicating the multi-line `find` block was not being located.
2.  `test_editing_file_where_find_text_is_not_found_fails`: An assertion on the error message format failed due to unexpected double single-quotes.

The investigation confirmed two separate, systemic root causes.

## 2. Investigation Summary
The investigation followed two parallel paths, confirming one hypothesis for each failure.

*   **Multiline Find Failure:** The initial hypothesis that the `LocalFileSystemAdapter`'s logic was flawed was refuted by an instrumented spike (`spikes/debug/02-inspect-multiline-vars/`). The investigation then shifted to the integration layer, and a subsequent spike (`spikes/debug/03-verify-yaml-parsing/`) **confirmed** that the application's YAML parser (`PyYAML`) was stripping common leading whitespace from the multi-line `find` string provided by the test.

*   **Error Quoting Failure:** A systematic reading of the code path, from exception creation (`models.py`) through handling (`plan_service.py`) to final output (`cli_formatter.py`), identified the exact line of code in the formatter responsible for the incorrect quoting.

## 3. Root Causes

### 3.1. YAML Parser Strips Test-Specific Indentation
The root cause of the `test_multiline_edit_preserves_indentation` failure is a misunderstanding of `PyYAML`'s behavior. The test constructs the `find` parameter with significant indentation for readability within the source code. However, the YAML parser's `safe_load` function correctly identifies this as common indentation for the literal block and removes it, as verified in `spikes/debug/03-verify-yaml-parsing/`. The resulting un-indented string is then (correctly) not found by the adapter in the original, fully-indented file content.

### 3.2. Incorrect Error Message Escaping in CLI Formatter
The root cause of the `test_editing_file_where_find_text_is_not_found_fails` failure is a bug in `src/teddy/adapters/inbound/cli_formatter.py`. The code attempts to escape single quotes for YAML compatibility, but does so incorrectly for the final raw text output.

```python
# Location: src/teddy/adapters/inbound/cli_formatter.py

# This line incorrectly replaces single quotes with double single-quotes
error_msg = str(result.error).replace("'", "''")
```
This transforms a message like `Search text 'goodbye' not found` into `Search text ''goodbye'' not found`, which breaks the test's assertion.

## 4. Verified Solutions

### 4.1. Solution for YAML Parser Issue
The fix is to modify the `test_multiline_edit_preserves_indentation` test itself. The `find_block` variable in the test should be defined exactly as it appears in the `initial_content`, without the extra indentation added by `textwrap.indent`. The YAML plan construction should also be modified to not add extraneous leading whitespace.

```python
# Verified Fix for tests/acceptance/test_edit_action.py

# The find_block should be defined with its real indentation
find_block = textwrap.dedent(
    """\
        # This is the block to be replaced
        if True:
            print("Old logic")
        # End of block"""
)

# The YAML plan should not add its own layer of indentation to the block
plan = f"""
- action: edit
  params:
    file_path: "source.py"
    find: |
{textwrap.indent(find_block, ' ' * 4)} # Indent to match source file exactly
    replace: |
      # This is the new block
      if False:
          print("New logic")
      # End of new block
"""
```
*Note: The core issue is that the string passed to the parser must match the file content after the parser processes it. The most robust fix is to ensure the `find` string in the test accurately reflects the file content from the root indentation level.*

### 4.2. Solution for Error Quoting Bug
The fix is to remove the incorrect string replacement from `src/teddy/adapters/inbound/cli_formatter.py`.

```python
# Verified Fix for src/teddy/adapters/inbound/cli_formatter.py

# FIND:
error_msg = str(result.error).replace("'", "''")
details_lines.append(f"  error: {error_msg}")

# REPLACE:
details_lines.append(f"  error: {result.error}")
```
This ensures the error message generated by the service layer is presented to the user without modification.
