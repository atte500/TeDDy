# RCA: Absolute Path Resolution Bug in `LocalFileSystemAdapter`

- **Status:** Resolved
- **Date:** 2026-02-06
- **Author:** Debugger AI

## 1. Summary

A critical bug in the `LocalFileSystemAdapter` caused 30 integration and acceptance tests to fail with `FileNotFoundError`. The issue stemmed from incorrect handling of absolute file paths, specifically those generated by `pytest`'s `tmp_path` fixture. The adapter was incorrectly prepending the project's current working directory (CWD) to these absolute paths, resulting in invalid, non-existent paths. The fix corrects the resolution logic, resolving all 30 failures.

## 2. Root Cause Analysis

The root cause was a flawed human assumption embedded in the `_resolve_path` private method.

1.  **The Flawed Assumption:** The original developer implemented a convention where paths starting with a `/` (e.g., `/README.md`) should be treated as relative to the project's root directory.
2.  **The Flawed Implementation:** To achieve this, the code unconditionally stripped the leading `/` from any path that started with it: `if path.startswith("/"): path = path[1:]`.
3.  **The Unintended Consequence:** This logic did not account for *genuine* absolute paths, such as `/private/var/...` provided by `pytest`'s `tmp_path` fixture. The code would incorrectly strip the leading slash, turning a valid absolute path into an invalid relative path (e.g., `private/var/...`). The method would then join this corrupted relative path with the CWD, causing the `FileNotFoundError`.

This was confirmed with a fault-isolation spike that demonstrated the incorrect path transformation outside of the test suite.

## 3. Solution

The fix re-orders the logic in `_resolve_path`. It now checks if a path is absolute *before* attempting to handle the project-root-relative convention. This ensures genuine absolute paths are preserved while the intended convention for project-relative paths continues to work.

**Change in `src/teddy_executor/adapters/outbound/local_file_system_adapter.py`:**

```diff
--- a/src/teddy_executor/adapters/outbound/local_file_system_adapter.py
+++ b/src/teddy_executor/adapters/outbound/local_file_system_adapter.py
@@ -32,21 +32,18 @@
         logger.debug(f"Input path: '{path}'")
         logger.debug(f"Adapter root_dir: '{self.root_dir}'")

-        # Strip leading slash first to treat it as relative to root_dir.
-        # This ensures that a path like '/file.txt' is not misinterpreted
-        # as a filesystem-absolute path by Path.is_absolute() on Unix.
+        path_obj = Path(path)
+
+        # First, check if the original path is absolute. If so, use it directly.
+        # This correctly handles paths from pytest's tmp_path fixture on Unix.
+        if path_obj.is_absolute():
+            logger.debug(f"Path is absolute, returning directly: '{path_obj}'")
+            return path_obj
+
+        # Handle the project-root-relative convention (e.g., '/file.txt').
+        # This is now safe because we've already handled true absolute paths.
         if path.startswith("/"):
             path = path[1:]
             logger.debug(f"Path after stripping '/': '{path}'")
-
-        path_obj = Path(path)
-        # If path is now absolute after stripping, use it directly.
-        # This would only happen on Windows with paths like 'C:\...'.
-        if path_obj.is_absolute():
-            logger.debug(f"Path is absolute, returning directly: '{path_obj}'")
-            return path_obj
-
         resolved_root = self.root_dir.resolve()
         logger.debug(f"Resolved adapter root_dir: '{resolved_root}'")


```

## 4. Verification

The fix was verified by re-running the full test suite (`pytest`). The original 30 failing tests all passed.

## 5. Lessons Learned & Next Steps

This resolution has exposed a new, separate bug in an upstream component, which was previously masked by this bug.

*   **New Issue:** The `MarkdownPlanParser` extracts link destinations like `[/file.txt](/file.txt)` and passes the path `/file.txt` to the `FileSystemManager`.
*   **Impact:** With the adapter now correctly recognizing this as an OS-absolute path, it attempts to perform file operations on the root of the filesystem, leading to `Read-only file system` or `No such file or directory` errors.
*   **Recommendation:** The `MarkdownPlanParser` should be modified to resolve these project-root-relative paths against the CWD *before* passing them to the `FileSystemManager`. The adapter layer should receive paths that are either truly absolute or correctly relative to the CWD.
