# RCA: `test_successfully_editing_multiline_content` Failure

## 1. Summary
The system experienced an `AssertionError` in the acceptance test `tests/acceptance/test_edit_action.py::test_successfully_editing_multiline_content`. The test failed because the file it intended to modify was left unchanged, suggesting a failure in the `edit_file` logic.

## 2. Investigation Summary
The investigation initially focused on the `edit_file` method within the `LocalFileSystemAdapter`, but this was proven to be a red herring. The true root cause was discovered by systematically testing the data flow from the test to the application.

1.  **Hypothesis: `find` string is malformed in the test.** Confirmed by `spikes/debug/01-.../`. The test's use of `textwrap.indent(...).strip()` created a string with incorrect internal indentation.
2.  **Hypothesis: The malformed string breaks the `edit_file` logic.** Refuted by `spikes/debug/02-.../`. An MRE proved the `edit_file` method was surprisingly robust and could handle the malformed string correctly. This crucial finding shifted the investigation's focus to the application's entrypoint.
3.  **Hypothesis: The YAML parsing layer is the point of failure.** Confirmed by `spikes/debug/03-.../`. A spike attempting to parse the YAML `plan` generated by the test failed with a `yaml.scanner.ScannerError`. This proved the test was generating syntactically invalid YAML.

## 3. Root Cause
The definitive root cause is the incorrect generation of a multiline YAML string within the `test_successfully_editing_multiline_content` function. The combination of an f-string, `textwrap.indent()`, and `.strip()` on the multiline `find` and `replace` blocks produced a string that was not valid YAML. Specifically, the content of the literal block scalar (`|`) was not properly indented relative to its parent key (`find:`), causing the application's YAML parser to raise a `ScannerError`. The application would then exit, and the test would subsequently (and correctly) assert that the target file was never modified.

## 4. Verified Solution
The solution is to correct the test setup in `tests/acceptance/test_edit_action.py` to ensure it generates syntactically valid YAML. This involves two key changes:
1.  Wrapping the `plan` f-string in `textwrap.dedent()` to ensure consistent base indentation, matching other tests.
2.  Replacing the flawed `.strip()` call with a proper `textwrap.indent()` call that correctly indents the multiline blocks to be valid content for a YAML literal block scalar.

The following code, which can be used to replace the relevant section in the test, demonstrates the fix:

```python
# In tests/acceptance/test_edit_action.py

    # ... inside test_successfully_editing_multiline_content ...

    find_block = textwrap.dedent("""
        - name: typer
          version: 0.4.0
    """).strip()

    replace_block = textwrap.dedent("""
        - name: typer
          version: 0.5.0
    """).strip()

    # Correctly indent the blocks for valid YAML content.
    # The `find:` key is at 8 spaces in the dedented plan. Content needs more (e.g., 10).
    indented_find = textwrap.indent(find_block, "          ")
    indented_replace = textwrap.indent(replace_block, "          ")

    plan = textwrap.dedent(f"""
    - action: edit
      params:
        file_path: "file.txt"
        find: |
{indented_find}
        replace: |
{indented_replace}
    """)

    # Act
    result = run_teddy(plan, cwd=test_dir)

    # Assert...
```
