# New Plan Format Specs

## 1. Core Principles

This format is designed to be a perfectly readable Markdown document first, and a machine-parseable plan second.

1.  **Markdown-First:** The document uses standard Markdown headings (`#`, `##`, `###`) to create a readable structure. The layout should feel natural to anyone familiar with Markdown.
2.  **Single Source of Truth (SoT):** All data and metadata are written once directly in the visible Markdown content. There is no hidden or duplicated data.
3.  **Hierarchical Structure:** The plan is a hierarchy of components. The parser should walk the Markdown AST, and the content of any given heading level contains all sub-levels. For example, the `## Action Plan` section contains all the individual action blocks defined by `###` headings.

## 2. Overall Document Structure

### 2.1. Dynamic Code Fencing

A core principle of this format is that it must reliably handle nested code blocks, which is a common source of errors in LLM-generated Markdown.

-   **The Problem:** If a code block's content contains a sequence of backticks (e.g., ` ``` `) that is the same length as the enclosing fence, the Markdown becomes invalid and cannot be parsed correctly.
-   **The Rule (Primary Defense):** When creating a fenced code block, the fence **must** use a number of backticks that is strictly greater than the longest sequence of backticks found anywhere inside the content. This instruction is the primary defense against parsing errors.
-   **System Support (Automatic Pre-processing):** To guarantee robustness, the system includes a pre-processing step that is **run automatically** by the `teddy plan` command. Before any plan generated by an AI is saved to `plan.md`, it is first passed through a sanitizer that dynamically rewrites any ambiguous code fences. This ensures that any plan on the filesystem is always safe to parse.

-   **Manual Override (`teddy preprocess`):** For cases where a plan is brought in from an external source (e.g., copied from a web UI), the system also exposes this sanitization logic as a manual `teddy preprocess` command. This utility allows a user to correct a plan file in-place or via the clipboard. See the [CLI Command Specification](/docs/specs/interactive-session-workflow.md#teddy-preprocess) for full details.

A plan is a single Markdown file with the following top-level structure:

```markdown
# [Descriptive Plan Title]
- **Status:** ...
- **Agent:** ...
...

## Rationale
...

## Memos
... (Optional: Contains a list of memory changes)

## Action Plan
... (Contains one or more action blocks)
```

## 3. File Linking Conventions

To ensure links work correctly in local previews (like VSCode) while referencing the project root, a specific syntax must be used.

-   **Root-Relative Links (Required):** All links to files within the project must be relative to the project's root directory.
    -   **Syntax:** `[path/from/root](/path/from/root)`
    -   **Explanation:** The link text (in square brackets) is the path from the root *without* a leading slash. The link destination (in round brackets) is the same path *with* a leading slash.
    -   **Example:** `[docs/ARCHITECTURE.md](/docs/ARCHITECTURE.md)`
    -   **Behavior:** This specific structure ensures that the link text is displayed cleanly while the link itself resolves correctly from the project root in the previewer.

## 4. Core Component Blocks

### 4.1. Plan Header

-   **Purpose:** Contains the plan's title and high-level metadata. It must be the first and only Level 1 (`#`) heading in the document.
-   **Format:**
    ```markdown
    # A Descriptive Plan Title
    - **Status:** Green ðŸŸ¢
    - **Plan Type:** Implementation
    - **Agent:** Pathfinder
    ```
-   **Parsing Rules:** The plan's title is the content of the `#` heading. The metadata is the bulleted list that immediately follows it. The parser should treat this list as key-value pairs.

### 4.2. Rationale

-   **Purpose:** Contains the agent's reasoning, state, and thought process. It acts as a **cognitive forcing function** to ensure every plan is grounded, deliberate, and strategic.
-   **Format:** The `Rationale` block is a plain text code block that **must** contain four distinct sections, each with a `###` heading, in the following order: `### 1. Synthesis`, `### 2. Justification`, `### 3. Expected Outcome`, and `4. State Dashboard`.

    `````markdown
    ## Rationale
    ````text
    ### 1. Synthesis
    [A review of the previous turn's outcome and what it means for the mission.]

    ### 2. Justification
    [A direct narrative that synthesizes the current situation and explains how the proposed plan is the next logical step according to all applicable principles of the agent's core methodology.]

    ### 3. Expected Outcome
    [A clear statement of what will happen in both success and failure scenarios, including the `Plan Type` of the subsequent plan.]

    ### 4. State Dashboard
    [The agent's complete, multi-step workflow status (e.g., Pathfinder's Log).]
    ````
    `````
-   **Parsing Rules:** The content is the raw text within the fenced code block and is primarily for human consumption and agent self-correction. The outer fence for the `Rationale` block must follow the **Dynamic Code Fencing** rule.

### 4.3. Memos (Optional)

-   **Purpose:** Lists the proposed changes (creations and deletions) to the agent's long-term memory.
-   **Format:**
    `````markdown
    ## Memos
    ````
    [+] A new fact to remember. # A new global convention was established.
    [-] An old fact that is no longer true. # This rule was superseded.
    ````
    `````
-   **Parsing Rules:** The parser should treat the content of the code block as a list of change requests.
    -   Each line must start with either `[+]` for creation or `[-]` for deletion. The text following the marker is the content of the memo.
    -   Any text following a `#` character on a line is considered a comment and should be ignored by the parser, but may be used by the presentation layer.

## 5. Action Blocks

All actions are located under the `## Action Plan` heading. Each action is defined by its own `###` heading.

### 5.1. `CREATE`

-   **Purpose:** Creates a new file.
-   **Format:**
    `````markdown
    ### `CREATE`
    - **File Path:** [docs/specs/plan-format.md](/docs/specs/plan-format.md)
    - **Description:** Create the initial specification document.
    ````markdown
    # Specification: The Pure Markdown Plan Format
    ... file content ...
    ````
    `````
-   **Parsing Rules:**
    1.  Extract `File Path` and `Description` from the metadata list.
    2.  The content for the new file is the entire content of the first fenced code block.

### 5.2. `READ`

-   **Purpose:** Reads a local file or remote URL to gather information.
-   **System Behavior:** A successful `READ` will cause the system to automatically add the target resource to the context for the *next* turn.
-   **Format:**
    ````markdown
    ### `READ`
    - **Resource:** [docs/ARCHITECTURE.md](/docs/ARCHITECTURE.md) or [www.example.com](https://example.com/docs)
    - **Description:** Read the current architectural conventions.
    ````
-   **Parsing Rules:**
  1.  Extract `Resource` and `Description` from the metadata list.
  2.  The value for `Resource` can be a root-relative Markdown link `[text](/destination)` for a local file, or a standard Markdown link `[text](URL)` for a remote resource.
  3.  If the destination starts with `/`, the parser **must** treat it as a local file path.
  4.  If the destination starts with `http`, the parser **must** treat it as a URL.

### 5.3. `EDIT`

-   **Purpose:** Edits an existing file. It is strongly preferred to make surgical changes by including multiple, small, sequential `FIND`/`REPLACE` pairs in a single action rather than one large replacement.
-   **Format:**
    ``````markdown
    ### `EDIT`
    - **File Path:** [prompts/architect.xml](/prompts/architect.xml)
    - **Description:** Update the output formatting instructions.

    `FIND:`
    `````xml
    A unique snippet of text, which might include ``` backticks, to be replaced.
    `````
    `REPLACE:`
    `````xml
    The new content.
    `````

    `FIND:`
    ````xml
    Another snippet to replace.
    ````
    `REPLACE:`
    ````xml
    Its corresponding new content.
    ````
    ``````
-   **Parsing Rules:**
    1.  Extract `File Path` and `Description`.
    2.  The parser looks for sequential pairs of `FIND:` and `REPLACE:` blocks. Each block is a standard fenced code block.
    3.  **Surgical Changes:** An `EDIT` action must contain at least one `FIND`/`REPLACE` pair. Full-file overwrites are strictly forbidden.

### 5.4. `EXECUTE`

-   **Purpose:** Executes a shell command.
-   **Format:**
    `````markdown
    ### `EXECUTE`
    - **Description:** Verify the new file was created.
    - **Expected Outcome:** The output will list `plan-format.md`. If a test is expected to fail, specify the exact `AssertionError` or error message.
    - **cwd:** (Optional) path/to/working/dir
    - **env:** (Optional)
        - `VAR1`: "value1"
        - `VAR2`: "value2"
    ````shell
    ls -l docs/specs/
    ````
    `````
-   **Parsing Rules:**
    1.  Extract `Description`, `Expected Outcome`, and the optional `cwd` and `env` parameters.
    2.  The command to execute is the entire content of the first fenced code block.

### 5.5. `RESEARCH`

-   **Purpose:** Performs multiple, distinct web searches.
-   **Format:**
    `````markdown
    ### `RESEARCH`
    - **Description:** Find libraries for parsing Markdown and providing syntax highlighting.
    ````text
    javascript markdown parser library
    ````
    ````text
    best python markdown to html
    ````
    ````text
    prism.js cdn link
    ````
    `````
-   **Parsing Rules:**
    1.  Extract `Description`.
    2.  The parser should treat every fenced code block as a separate query.

### 5.6. `CHAT_WITH_USER`

-   **Purpose:** Communicates with the user.
-   **Format:**
    ```markdown
    ### `CHAT_WITH_USER`
    I have created a draft brief at `docs/briefs/01-finisher-agent-brief.md` and will now begin my research.

    This is a standard checkpoint to ensure we are aligned before I proceed with the research phase. Does this initial direction meet with your approval?
    ```
-   **Parsing Rules:** The content for the chat message is all the free-form markdown content under the `### CHAT_WITH_USER` heading.

### 5.7. `INVOKE`

-   **Purpose:** Hands off control to another agent, resetting the context for a new task.
-   **Format:**
    ```markdown
    ### `INVOKE`
    - **Agent:** Architect
    - **Handoff Resources:** (Optional)
      - [docs/briefs/new-feature.md](/docs/briefs/new-feature.md)

    Handoff to the Architect. The brief is complete.
    ```
-   **Parsing Rules:**
    1. Extract the target `Agent` from the metadata list.
    2. Extract the optional list of `Handoff Resources`.
    3. The content for the invocation message is all the free-form markdown content that follows the metadata list.

### 5.8. `CONCLUDE`

-   **Purpose:** Returns control to the calling agent after a specialist sub-task is complete.
-   **Format:**
    ```markdown
    ### `CONCLUDE`
    - **Handoff Resources:** (Optional)
      - [docs/rca/the-bug.md](/docs/rca/the-bug.md)
      - [spikes/fix-script.sh](/spikes/fix-script.sh)

    My analysis is complete. The root cause and a verified fix are attached.
    ```
-   **Parsing Rules:**
    1. Extract the optional list of `Handoff Resources`.
    2. The content for the message is all the free-form markdown content that follows the metadata list.

### 5.9. `PRUNE`

-   **Purpose:** Removes a resource from the agent's working context for subsequent turns. This is used to prevent context clutter.
-   **Format:**
    ````markdown
    ### `PRUNE`
    - **Resource:** [docs/specs/old-spec.md](/docs/specs/old-spec.md)
    - **Description:** Remove the old specification as it is no longer relevant.
    ````
-   **Parsing Rules:**
    1.  Extract `Resource` and `Description` from the metadata list.
    2.  The value for `Resource` will be a root-relative Markdown link `[text](/destination)`. The parser should use the destination as the path to remove from the context.

## 6. Comprehensive Example Plan

The following is a complete, realistic example of a plan file from start to finish.

`````markdown
# Research and Propose a New "Finisher" Agent Role
- **Status:** Green ðŸŸ¢
- **Plan Type:** Exploration
- **Agent:** Pathfinder

## Rationale
````text
### 1. Synthesis
The user has requested a new "Finisher" agent role, but the exact responsibilities are undefined. This requires a discovery process before implementation.

### 2. Justification
This plan adheres to the Pathfinder "Why -> What -> How" workflow. The problem is understood ("Why"), but the solution is not. Therefore, the next logical step is to explore the Solution Space ("What") by gathering external information to inform a proposal.

### 3. Expected Outcome
The research is expected to yield patterns for release management roles, allowing me to draft a brief. The next plan will be a `Synthesis` plan. If the research yields no clear patterns, the next plan will be a `CHAT_WITH_USER` plan to propose a brainstorming session with the user.

### 4. State Dashboard
- **Overall Goal:** Define and get approval for a new "Finisher" agent.
- **Phase A: Problem Space (Why):** Approved
- **Phase B: Solution Space (What):** In Progress
- **Phase C: Implementation Space (How):** Not Started
- **Phase D: Handoff (Who):** Not Started
````

## Memos
````
[+] A new 'Finisher' agent role is being explored.
[-] The 'Architect' agent is responsible for all handoffs.
````

## Action Plan

### `RESEARCH`
- **Description:** Research existing software development roles and CI/CD pipeline patterns related to finalization and release management.
````text
software development release manager responsibilities
````
````text
gitflow vs trunk-based development final steps
````

### `CREATE`
- **File Path:** [docs/briefs/01-finisher-agent-brief.md](/docs/briefs/01-finisher-agent-brief.md)
- **Description:** Create the initial draft of the brief for the new "Finisher" agent.
````markdown
# Brief: The "Finisher" Agent

## 1. Business Goal
To streamline the end-of-task workflow by automating final code/documentation cleanup, versioning, and handoff notifications.

## 2. Technical Requirements
*(This section will be populated after research is complete.)*
````

### `EDIT`
- **File Path:** [prompts/pathfinder.xml](/prompts/pathfinder.xml)
- **Description:** Temporarily add the Finisher agent to the Pathfinder's list of handoff targets.

`FIND:`
````xml
<handoff_targets>
  <agent>Architect</agent>
  <agent>Debugger</agent>
</handoff_targets>
````
`REPLACE:`
````xml
<handoff_targets>
  <agent>Architect</agent>
  <agent>Debugger</agent>
  <agent>Finisher</agent>
</handoff_targets>
````

### `CHAT_WITH_USER`
I have created a draft brief at `docs/briefs/01-finisher-agent-brief.md` and will now begin my research. I will report back with my findings and a more detailed proposal for the brief.

Does this initial direction meet with your approval?

### `INVOKE`
- **Agent:** Architect

Handoff to Architect to begin implementation of the approved brief.
`````
