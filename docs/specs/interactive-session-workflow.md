# Interactive session workflow specs

## 1. Overview

This document specifies the design and behavior of the new interactive, file-based session workflow for TeDDy. The goal is to create a robust, stateless, and versionable workflow that replaces the need for ephemeral chat UIs and provides a complete, auditable history of the AI collaboration.

## 2. The Core Directory Structure

The system uses a top-level `.teddy/` directory to store all persistent data.

```
.teddy/
├── global.context               # Global context for all sessions
├── memos.yaml                   # Global, persistent memory file
└── sessions/
    └── 20260124-add-user-auth/      # Session Directory
        ├── session.context          # Session-specific context file
        └── 01/                      # Turn 1
            ├── turn.context         # List of file paths for the AI's context
            ├── _context.log         # The full, audited input sent to the AI
            ├── plan.md              # The plan generated by the AI
            └── report.md            # The execution report of the plan
```

Each "turn" within a session is an immutable directory, numbered sequentially.

```
.teddy/sessions/
└── 20260124-add-user-auth/          # Session Directory
    ├── session.context              # Session-specific context file
    ├── 01/                          # Turn 1
    │   ├── turn.context             # List of file paths for the AI's context
    │   ├── _context.log             # The full, audited input sent to the AI
    │   ├── plan.md                  # The plan generated by the AI
    │   └── report.md                # The execution report of the plan
    ├── 02/                          # Turn 2
    │   ├── turn.context
    │   ├── _context.log
    │   ├── plan.md
    │   └── report.md
    └── 02-branch-01/                # A branch from turn 2
        ├── turn.context
        └── _context.log
        └── plan.md
```

## 3. Core Artifacts

-   **`turn.context`**: A newline-delimited text file containing only the list of file paths to be included in the AI's context for that turn.
-   **`_context.log`**: The single source of truth for what the AI was shown in a given turn. It includes the system prompt, the user's message, and the full content of all files specified in `turn.context`. This file is for auditing and reproducibility.
-   **`plan.md`**: The raw markdown file generated by the AI, containing its Rationale and an optional `Active Context` section for the next turn. It is considered an immutable input to the `execute` command.
-   **`report.md`**: A Markdown file containing the `ExecutionReport`. It is the immutable output of the `execute` command.
-   **`.teddy/memos.yaml`**: A global YAML file containing a list of strings, representing facts for the AI's long-term memory.
    -   **Example Format:**
        ```yaml
        - All API endpoints must be documented in OpenAPI spec.
        - Use 'pnpm' for all package management.
        ```

## 4. Context Management

Context is determined by a cascading hierarchy of files. The `teddy` tool will aggregate file paths from these files, with definitions in lower levels overriding those in upper levels.

1.  **Global Context (`.teddy/global.context`):** Defines file paths that should be included in *every* session and turn (e.g., `README.md`, `ARCHITECTURE.md`).
2.  **Session Context (`<session>/session.context`):** Defines file paths relevant for the entire session. Managed by the user.
3.  **Turn Context (from `Active Context`):** The `Active Context` section in a `plan.md` file specifies a set of *changes* (additions and deletions) to be applied to the previous turn's context to generate the context for the *next* turn. The tooling calculates the new `turn.context` by applying these changes. If the `Active Context` section is omitted from the plan, the `turn.context` from the previous turn is carried over unmodified.

## 5. CLI Command Specification

This section defines the new top-level commands for managing the session workflow.

---

### `teddy new <name>`

Initializes a new session directory.

-   **Arguments:**
    -   `<name>`: A descriptive, kebab-case name for the session (e.g., "implement-auth-flow").
-   **Behavior:**
    1.  Creates the session directory (e.g., `.teddy/sessions/TIMESTAMP-implement-auth-flow/`).
    2.  Creates the session-specific context file at `.teddy/sessions/TIMESTAMP-implement-auth-flow/session.context`.
    3.  Outputs the path to the new session directory.

---

### `teddy plan -m <message>`

Explicitly generates the next plan in a session.

-   **Options:**
    -   `-m, --message <message>`: The user's prompt for this turn.
-   **Behavior:**
    1.  Identifies the latest turn directory in the current session.
    2.  **Guard Clause:** If the latest turn contains a `plan.md` but no `report.md`, the command MUST fail with an error stating that the current plan must be executed first (suggesting `teddy resume`).
    3.  Creates the next turn directory, assembles context, generates the payload, calls the AI, and saves the response to `plan.md`.

---

### `teddy execute [plan_file]`

Executes a one-off plan. This command is **not** session-aware.

-   **Arguments:**
    -   `[plan_file]`: (Optional) Path to a Markdown plan file. If omitted, reads from the clipboard.
-   **Options:**
    -   `-y`: (Optional) Auto-approve all actions.
-   **Behavior:**
    1.  Reads the plan content from the specified file or the clipboard.
    2.  Parses and executes the plan.
    3.  Writes the final `ExecutionReport` to a Markdown file (`report.md`) in the current working directory.

---

### `teddy resume`

The primary "continue" command for a session. It intelligently determines the next action.

-   **Behavior:**
    1.  Identifies the latest turn in the current session.
    2.  **State Check:**
        -   If the turn is complete (has a `report.md`), it prompts the user for a message and proceeds to the planning phase (identical to `teddy plan`).
        -   If the turn has a `plan.md` but no `report.md`, it proceeds to the **Approval & Execution Phase**.

-   **Approval & Execution Phase:**
    This phase implements a two-tiered workflow to give the user both speed and granular control.

    **Tier 1: High-Level Summary & Prompt**
    The command first presents a high-level summary of all proposed state changes (`Active Context`, `Memos`) and the actions to be performed.

    *Example UI:*
    ```text
    ▶ Reviewing Plan: "Bootstrap New Project Component"
    --------------------------------------------------------------------

     Active Context:
      [+] ADD:    src/components/new_component/core.py   # Add new core logic file to context.
      [+] ADD:    tests/components/test_new_component.py # Add new test file to context.

     memos.yaml:
      [+] ADD:    All new components must have a core.py file. # Establish a new convention.

     Action Plan:
      - CREATE: 1 file
      - EDIT:   1 file
      - EXECUTE: 1 command

    --------------------------------------------------------------------
    Execute this plan? (a)pprove all / (m)odify / (s)kip / (q)uit ›
    ```
    -   `(a)pprove all`: Executes the entire plan non-interactively.
    -   `(m)odify`: Enters Tier 2 for granular control.
    -   `(s)kip`: Aborts execution and prompts for a message to generate a new plan.
    -   `(q)uit`: Exits the session.

    **Tier 2: Interactive "Modify & Preview" Mode**
    If the user selects `(m)odify`, they enter an interactive checklist to configure the plan before execution. The tool will execute all checked items as a single batch, in their original order, once the user confirms their selections.

    *Example UI:*
    ```text
    Use [↑/↓] to navigate, [space] to toggle, (p)review details, [enter] to confirm.

    [✅] Active Context
     │
     ├─[✅] [+] ADD: src/components/new_component/core.py
     └─[✅] [+] ADD: tests/components/test_new_component.py

    [✅] Memos
     │
     └─[✅] [+] ADD: All new components must have a core.py file.

    [✅] Action Plan
     │
     ├─[✅] CREATE: src/components/new_component/core.py
     ├─[✅] EDIT:   pyproject.toml
     └─[✅] EXECUTE: poetry lock
    ```
    -   **Controls:** Users can navigate the list, toggle items on/off with the spacebar, and press `[enter]` to confirm and execute the configured plan.

    -   **Universal On-Demand Previews:** When any item is highlighted, pressing `(p)` will show a detailed preview. This feature is designed to provide complete transparency before execution. The preview mechanism is configurable and follows a defined fallback order (see Configuration section below).
        -   `CREATE`: Shows the full content of the new file.
        -   `READ`: Reads the target file/URL and displays its content.
        -   `EDIT`: Computes and displays a colorized diff of the proposed changes.
        -   `EXECUTE`: Displays the full command and any associated parameters (e.g., `cwd`, `env` variables).
        -   `RESEARCH`: Displays the list of search queries that will be executed.
        -   `CHAT_WITH_USER`: Displays the full message that will be sent to the user.
        -   `INVOKE`: Displays the target agent and the full handoff message.

<!-- Implementation Note -->
> A technical spike has validated that this interactive checklist will be implemented using the `textual` TUI framework, as it provides the necessary event loop and widget toolkit for this level of interactivity.

---

## 6. Configuration (`.teddy/config.yaml`)

User-specific behavior for the `teddy` tool can be defined in an optional `.teddy/config.yaml` file.

-   **`preview_command`**: (Optional) A string defining the shell command to use for the `(p)review` feature. The tool will write the preview content to a temporary file and pass its path as the final argument to this command.

    -   *Example for Neovim:* `preview_command: "nvim -R"`
    -   *Example for VS Code:* `preview_command: "code"` # Note: Use without `--wait` for a non-blocking preview.

-   **Previewer Fallback Logic:** When the user triggers a preview, the tool will use the following logic to determine how to display it:
    1.  **Configured Editor:** If `preview_command` is set in `.teddy/config.yaml`, it will be used.
    2.  **Visual Studio Code (Default):** If the `code` command is available in the system's `PATH`, it will be used as the default external editor.
    3.  **In-Terminal Display (Fallback):** If neither of the above is available, a colorized diff or formatted content will be printed directly to the terminal.

---

### `teddy branch <turn>`

Creates a new conversational branch from a given turn.

-   **Arguments:**
    -   `<turn>`: The turn directory to branch from (e.g., `02`).
-   **Behavior:**
    1.  Creates a new turn directory named `<turn>-branch-<nn>` (e.g., `02-branch-01`).
    2.  Copies `turn.context` and `_context.log` from the original turn into the new branch directory.
