# Interactive session workflow specs

## 1. Overview

This document specifies the design and behavior of the new interactive, file-based session workflow for TeDDy. The goal is to create a robust, stateless, and versionable workflow that replaces the need for ephemeral chat UIs and provides a complete, auditable history of the AI collaboration.

## 2. The Core Directory Structure

The system uses a top-level `.teddy/` directory to store all persistent data.

```
.teddy/
├── global.context               # Global context for all sessions
├── memos.yaml                   # Global, persistent memory file
└── sessions/
    └── 20260124-add-user-auth/      # Session Directory
        ├── session.context          # Session-specific context file
        └── 01/                      # Turn 1
            ├── turn.context         # List of file paths for the AI's context
            ├── _context.log         # The full, audited input sent to the AI
            ├── plan.md              # The plan generated by the AI
            └── report.md            # The execution report of the plan
```

Each "turn" within a session is an immutable directory, numbered sequentially.

```
.teddy/sessions/
└── 20260124-add-user-auth/          # Session Directory
    ├── session.context              # Session-specific context file
    ├── 01/                          # Turn 1
    │   ├── turn.context             # List of file paths for the AI's context
    │   ├── _context.log             # The full, audited input sent to the AI
    │   ├── plan.md                  # The plan generated by the AI
    │   └── report.md                # The execution report of the plan
    ├── 02/                          # Turn 2
    │   ├── turn.context
    │   ├── _context.log
    │   ├── plan.md
    │   └── report.md
    └── 02-branch-01/                # A branch from turn 2
        ├── turn.context
        └── _context.log
        └── plan.md
```

## 3. Core Artifacts

-   **`turn.context`**: A newline-delimited text file containing only the list of file paths to be included in the AI's context for that turn.
-   **`_context.log`**: The single source of truth for what the AI was shown in a given turn. It includes the system prompt, the user's message, and the full content of all files specified in `turn.context`. This file is for auditing and reproducibility.
-   **`plan.md`**: The raw markdown file generated by the AI, containing its Rationale and a `Context Vault` for the next turn. It is considered an immutable input to the `execute` command.
-   **`report.md`**: A pure YAML file containing the `ExecutionReport`. It is the immutable output of the `execute` command.
-   **`.teddy/memos.yaml`**: A global YAML file containing a list of strings, representing facts for the AI's long-term memory.
    -   **Example Format:**
        ```yaml
        - All API endpoints must be documented in OpenAPI spec.
        - Use 'pnpm' for all package management.
        ```

## 4. Context Management

Context is determined by a cascading hierarchy of files. The `teddy` tool will aggregate file paths from these files, with definitions in lower levels overriding those in upper levels.

1.  **Global Context (`.teddy/global.context`):** Defines file paths that should be included in *every* session and turn (e.g., `README.md`, `ARCHITECTURE.md`).
2.  **Session Context (`<session>/session.context`):** Defines file paths relevant for the entire session. Managed by the user.
3.  **Turn Context (from `Context Vault`):** The `Context Vault` section in a `plan.md` file specifies the file paths for the *next* turn. The list of paths from here will be written into the next turn's `turn.context` file.

## 5. CLI Command Specification

This section defines the new `teddy session` subcommand.

---

### `teddy session new <name>`

Initializes a new session directory.

-   **Arguments:**
    -   `<name>`: A descriptive, kebab-case name for the session (e.g., "implement-auth-flow").
-   **Behavior:**
    1.  Creates the session directory (e.g., `.teddy/sessions/TIMESTAMP-implement-auth-flow/`).
    2.  Creates the session-specific context file at `.teddy/sessions/TIMESTAMP-implement-auth-flow/session.context`.
    3.  Outputs the path to the new session directory.

---

### `teddy session plan -m <message>`

Generates the next plan in the sequence.

-   **Options:**
    -   `-m, --message <message>`: The user's prompt for this turn.
    -   `-s, --session <path>`: (Optional) Path to the session directory. Defaults to the most recently created session.
    -   `-a, --agent <name>`: (Optional) The agent to use (e.g., `pathfinder`, `dev`). Defaults to `pathfinder` for the first turn, or the previously used agent.
-   **Behavior:**
    1.  Identifies the latest turn directory.
    2.  **Guard Clause:** If the latest turn contains a `plan.md` but no `report.md`, the command MUST fail with an error stating that the current plan must be executed first.
    3.  Creates the next turn directory (e.g., if latest is `01/`, creates `02/`).
    4.  Assembles the context paths from the cascading sources and writes them to the new `turn.context` file.
    5.  Reads the content of the global `.teddy/memos.yaml` file.
    6.  Generates the full context payload (prompts + memos + file contents) and saves it to `_context.log`.
    7.  Sends the content of `_context.log` to the AI model.
    8.  Saves the AI's response as `plan.md` in the new turn directory.

---

### `teddy session execute`

Executes the most recent plan that does not yet have a report.

-   **Options:**
    -   `-s, --session <path>`: (Optional) Path to the session directory. Defaults to the most recently created session.
    -   `-y`: (Optional) Auto-approve all actions.
-   **Behavior:**
    1.  Finds the latest turn directory that contains a `plan.md` but no `report.md`.
    2.  **Memo Update Step:**
        -   The system first checks the `plan.md` for an `## Memos` section.
        -   If found, it presents the proposed additions and deletions to the user for explicit approval (e.g., `Approve these memory updates? (y/n)`).
        -   If the user approves, the changes are immediately applied to the `.teddy/memos.yaml` file. If rejected, the changes are discarded.
        -   This step is mandatory and occurs before any actions are executed.
    3.  **Action Execution Step:**
        -   Parses the `## Action Plan` from the `plan.md` file.
        -   Executes the plan, **interactively by default**, prompting the user for approval on each action.
    4.  Writes the final `ExecutionReport` to `report.md` in the same turn directory.

---

### `teddy session branch <turn> -m <message>`

Creates a new conversational branch from the given turn.

-   **Arguments:**
    -   `<turn>`: The turn directory to branch from (e.g., `02`).
-   **Options:**
    -   `-s, --session <path>`: (Optional) Path to the session directory. Defaults to the most recently created session.
-   **Behavior:**
    1.  Creates a new turn directory named `<turn>-branch-<nn>` (e.g., `02-branch-01`).
    2.  Copies the `turn.context` and `_context.log` from the original turn (`02/`) into the new branch directory, allowing the user to re-run `plan` with a different message on the exact same context.
