# Interactive session workflow specs

## 1. Overview

This document specifies the design and behavior of the new interactive, file-based session workflow for TeDDy. The goal is to create a robust, stateless, and versionable workflow that replaces the need for ephemeral chat UIs and provides a complete, auditable history of the AI collaboration.

## 2. The Core Directory Structure

The system uses a top-level `.teddy/` directory to store all persistent data.

```
.teddy/
├── global.context               # Global context for all sessions
├── memos.yaml                   # Global, persistent memory file
└── sessions/
    └── 20260124-add-user-auth/      # Session Directory
        ├── session.context          # Session-specific context file
        └── 01/                      # Turn 1
            ├── turn.context         # List of file paths for the AI's context
            ├── _context.log         # The full, audited input sent to the AI
            ├── plan.md              # The plan generated by the AI
            └── report.md            # The execution report of the plan
```

Each "turn" within a session is an immutable directory, numbered sequentially.

```
.teddy/sessions/
└── 20260124-add-user-auth/          # Session Directory
    ├── session.context              # Session-specific context file
    ├── 01/                          # Turn 1
    │   ├── turn.context             # List of file paths for the AI's context
    │   ├── _context.log             # The full, audited input sent to the AI
    │   ├── plan.md                  # The plan generated by the AI
    │   └── report.md                # The execution report of the plan
    ├── 02/                          # Turn 2
    │   ├── turn.context
    │   ├── _context.log
    │   ├── plan.md
    │   └── report.md
    └── 02-branch-01/                # A branch from turn 2
        ├── turn.context
        └── _context.log
        └── plan.md
```

## 3. Core Artifacts

-   **`turn.context`**: A newline-delimited text file containing only the list of file paths to be included in the AI's context for that turn.
-   **`_context.log`**: The single source of truth for what the AI was shown in a given turn. It includes the system prompt, the user's message, and the full content of all files specified in `turn.context`. This file is for auditing and reproducibility.
-   **`plan.md`**: The raw markdown file generated by the AI, containing its Rationale and a `Context Vault` for the next turn. It is considered an immutable input to the `execute` command.
-   **`report.md`**: A Markdown file containing the `ExecutionReport`. It is the immutable output of the `execute` command.
-   **`.teddy/memos.yaml`**: A global YAML file containing a list of strings, representing facts for the AI's long-term memory.
    -   **Example Format:**
        ```yaml
        - All API endpoints must be documented in OpenAPI spec.
        - Use 'pnpm' for all package management.
        ```

## 4. Context Management

Context is determined by a cascading hierarchy of files. The `teddy` tool will aggregate file paths from these files, with definitions in lower levels overriding those in upper levels.

1.  **Global Context (`.teddy/global.context`):** Defines file paths that should be included in *every* session and turn (e.g., `README.md`, `ARCHITECTURE.md`).
2.  **Session Context (`<session>/session.context`):** Defines file paths relevant for the entire session. Managed by the user.
3.  **Turn Context (from `Context Vault`):** The `Context Vault` section in a `plan.md` file specifies the file paths for the *next* turn. The list of paths from here will be written into the next turn's `turn.context` file.

## 5. CLI Command Specification

This section defines the new top-level commands for managing the session workflow.

---

### `teddy new <name>`

Initializes a new session directory.

-   **Arguments:**
    -   `<name>`: A descriptive, kebab-case name for the session (e.g., "implement-auth-flow").
-   **Behavior:**
    1.  Creates the session directory (e.g., `.teddy/sessions/TIMESTAMP-implement-auth-flow/`).
    2.  Creates the session-specific context file at `.teddy/sessions/TIMESTAMP-implement-auth-flow/session.context`.
    3.  Outputs the path to the new session directory.

---

### `teddy plan -m <message>`

Explicitly generates the next plan in a session.

-   **Options:**
    -   `-m, --message <message>`: The user's prompt for this turn.
-   **Behavior:**
    1.  Identifies the latest turn directory in the current session.
    2.  **Guard Clause:** If the latest turn contains a `plan.md` but no `report.md`, the command MUST fail with an error stating that the current plan must be executed first (suggesting `teddy resume`).
    3.  Creates the next turn directory, assembles context, generates the payload, calls the AI, and saves the response to `plan.md`.

---

### `teddy execute [plan_file]`

Executes a one-off plan. This command is **not** session-aware.

-   **Arguments:**
    -   `[plan_file]`: (Optional) Path to a Markdown plan file. If omitted, reads from the clipboard.
-   **Options:**
    -   `-y`: (Optional) Auto-approve all actions.
-   **Behavior:**
    1.  Reads the plan content from the specified file or the clipboard.
    2.  Parses and executes the plan.
    3.  Writes the final `ExecutionReport` to a Markdown file (`report.md`) in the current working directory.

---

### `teddy resume`

The primary "continue" command for a session. It intelligently determines the next action.

-   **Behavior:**
    1.  Identifies the latest turn in the current session.
    2.  **Checks State:**
        -   If the turn has a `plan.md` but no `report.md`, it proceeds to the execution phase.
        -   If the turn is complete (has a `report.md`), it prompts the user for a message and proceeds to the planning phase (identical to `teddy plan`).
    3.  **Execution Phase:**
        -   Presents a plan summary and the `(y/n/yolo)` prompt.
        -   `y`: Proceeds to step-by-step approval.
        -   `n`: Aborts and asks for a reason.
        -   `yolo`: Executes all actions non-interactively.
        -   Handles memo updates and writes the final `report.md`.

---

### `teddy branch <turn>`

Creates a new conversational branch from a given turn.

-   **Arguments:**
    -   `<turn>`: The turn directory to branch from (e.g., `02`).
-   **Behavior:**
    1.  Creates a new turn directory named `<turn>-branch-<nn>` (e.g., `02-branch-01`).
    2.  Copies `turn.context` and `_context.log` from the original turn into the new branch directory.
