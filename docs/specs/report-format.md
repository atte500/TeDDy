# Specification: Unified Report Format

## 1. Overview and Core Principles

This document specifies the single, canonical format for all execution reports generated by `teddy`. It replaces and merges the previous "Rich Report" and "Concise Report" specifications.

The report is generated by a unified Jinja2 templating system, with its format and conventions derived directly from the canonical template: `src/teddy_executor/core/services/templates/concise_report.md.j2`.

### 1.1. Core Principles

1.  **Single Source of Truth:** The Jinja2 template is the definitive source for the report's structure and logic. This specification serves as human-readable documentation of that logic.
2.  **Architectural Consistency:** All reports, regardless of their purpose, are generated from the same data model and rendering logic.
3.  **Human & Machine Readable:** The format is Markdown-first, providing clarity for users while maintaining a parsable structure for AI agents.

### 1.2. Report Formats: Rich vs. Concise

The unified template can produce two variations of the report by passing a boolean flag (`is_concise`) to the formatter.

1.  **Rich Report (`is_concise=false`):** This is the default output for the stateful, interactive session workflow's `report.md` file. It is a verbose, file-based artifact designed to be a complete, auditable historical record. It includes all sections, including the original plan's `Rationale` and `Action Plan`.

2.  **Concise Report (`is_concise=true`):** This is a compact rendering optimized for the manual, CLI-based workflow. When this flag is true, the template **omits** verbose sections, such as the original plan's `Rationale`.

---

## 2. Document Structure

A report is a single Markdown file with the following structure. Sections are conditional and only rendered if they contain relevant data.

1.  **Report Header:** High-level summary of the execution.
2.  **Validation Errors (Conditional):** Appears only if pre-flight validation fails.
3.  **Resource Contents (Conditional):** Appears if validation fails for file-based actions, or if execution completes and there are `READ` successes or `CREATE`/`EDIT` failures.
4.  **Action Log:** A detailed, action-by-action log of the execution.

---

## 3. Section Specifications

### 3.1. Report Header

Provides a high-level summary. All keys must be bolded.

```markdown
# Execution Report: [Plan Title]
- **Overall Status:** [SUCCESS | FAILURE | VALIDATION_FAILED | SKIPPED]
- **Execution Start Time:** [ISO 8601 Timestamp]
- **Execution End Time:** [ISO 8601 Timestamp]
```

### 3.2. Validation Errors

If the plan fails pre-flight validation, this section is rendered. It contains a bulleted list of all validation errors found.

```markdown
## Validation Errors
- [Error message for the first failure.]
- [Error message for the second failure, including FIND block if applicable.]
```

### 3.3. Action Log

This is the main body of the report.

#### 3.3.1. Action Block Structure

Each action is rendered as a block, starting with a Level 3 (`###`) header.

##### **Action Header (`###`)**

The header format depends on the action type:
-   **For `EXECUTE` / `RESEARCH`:** `### \`ACTION_TYPE\`: "[Description]"`
-   **For `CREATE` / `EDIT` / `READ`:** `### \`ACTION_TYPE\`: [filename.ext](/path/to/filename.ext)`
-   **For `CHAT_WITH_USER` and others:** `### \`ACTION_TYPE\``

##### **Core Metadata**

-   `- **Status:** [SUCCESS | FAILURE | SKIPPED]`

##### **Skipped Action Details**

If an action's status is `SKIPPED`, a `Reason` must be provided.

-   **User Skip:** When a user explicitly skips an action.
    ```markdown
    - **Status:** SKIPPED
    - **Reason:** User skipped this action.
    - **Message:** `User's optional message here` (This line only appears if a message was provided)
    ```
-   **System Skip:** When the system skips an action due to a prior failure.
    ```markdown
    - **Status:** SKIPPED
    - **Reason:** Skipped due to a previous action's failure.
    ```

##### **Action-Specific Parameters & Details**

Parameters are rendered as a flattened list of key-value pairs. Large, verbatim content blocks from the plan (like `content`, `find`, `replace`) are always omitted. The generic `Details` field is not used.

-   **For `EXECUTE`:**
    ```markdown
    - **Expected outcome:** [The expected outcome string.]
    - **Command:** `[The command]` (or a fenced `shell` block for multi-line commands)
    - **Return Code:** `[exit code]`
    - **`stdout` / `stderr`:** Rendered in their own `####` sections with fenced code blocks.
    ```
-   **For `CHAT_WITH_USER`:** The AI's prompt is rendered directly, without a key. The user's response appears in a separate block.
    ```markdown
    [The AI's message to the user...]

    #### User Response
    ````text
    [The user's verbatim response...]
    ````
    ```
