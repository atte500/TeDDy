{#
  Unified template for the concise Markdown report.
  Renders both execution outcomes and pre-flight validation failures.

  NOTE ON WHITESPACE CONTROL:
  This template uses manual whitespace control (`-%}`) on blocks that are
  followed by blank lines. The Jinja2 `trim_blocks=True` setting only
  removes the *first* newline after a tag, not subsequent blank lines.
  The manual control is necessary to prevent extra newlines in the final
  rendered output when conditional sections are not rendered.
#}
{% macro render_resource(path, content) %}
---
**Resource:** `[{{ path | basename }}]({% if not path.startswith('/') %}/{% endif %}{{ path }})`
````text
{{ content }}
````
---
{% endmacro %}

{% macro render_action_details(log) %}
{% if log.details and not (log.action_type.lower() == 'read' and log.status.value == 'SUCCESS') -%}
{% if log.details is mapping and log.details.get("error") -%}
- **Error:** {{ log.details.error }}
{% elif log.details is mapping and log.action_type.lower() == 'execute' and log.status.value == 'FAILURE' -%}
{% if log.details.get("return_code") is not none -%}
- **Return Code:** `{{ log.details.return_code }}`
{% endif -%}
{% if log.details.get("stdout") -%}
#### `stdout`
````text
{{ log.details.stdout | trim }}
````
{%- endif %}
{% if log.details.get("stderr") -%}
#### `stderr`
````text
{{ log.details.stderr | trim }}
````
{%- endif %}
{%- else -%}
- **Details:** `{{ log.details }}`
{%- endif %}
{% endif %}
{% endmacro %}
# Execution Report: {{ report.plan_title | default('Untitled Plan') }}

- **Overall Status:** {{ "Validation Failed" if report.run_summary.status.value == "VALIDATION_FAILED" else report.run_summary.status.value }}
- **Execution Start Time:** {{ format_datetime(report.run_summary.start_time) }}
- **Execution End Time:** {{ format_datetime(report.run_summary.end_time) }}

{% if report.validation_result %}
## Validation Errors
{% for error in report.validation_result %}
- {{ error }}
{% endfor %}
{% if report.failed_resources %}

### Resource Contents
{% for path, content in report.failed_resources.items() %}
{{ render_resource(path, content) }}
{% endfor %}
{% endif %}
{% endif -%}

{# Extract successful READ logs for the Resource Contents section #}
{% set ns = namespace(read_logs=[]) %}
{% for log in report.action_logs %}
  {% if log.action_type.lower() == 'read' and log.status.value == 'SUCCESS' and log.details and 'content' in log.details %}
    {% set ns.read_logs = ns.read_logs + [log] %}
  {% endif %}
{% endfor -%}

{% if ns.read_logs %}
## Resource Contents
The following resource contents were successfully read.
{% for log in ns.read_logs %}
{% set res_path = log.params.get('Resource') or log.params.get('resource') or log.params.get('path') %}
{{ render_resource(res_path, log.details.content) }}
{% endfor %}
{% endif -%}

{# Extract failed logs for the Failed Action Details section #}
{% set ns.failed_logs = [] %}
{% for log in report.action_logs %}
  {% if log.status.value == 'FAILURE' %}
    {% set ns.failed_logs = ns.failed_logs + [log] %}
  {% endif %}
{% endfor -%}

{% if ns.failed_logs %}
## Failed Action Details

{% for log in ns.failed_logs %}
{% set action_target = log.params.get('File Path') or log.params.get('path') or log.params.get('Resource') or log.params.get('Description') or log.params.get('description') or 'Unknown' %}
### `{{ log.action_type.upper() }}` on `{{ action_target }}`
{% if log.details and log.details.error %}
- **Error:** {{ log.details.error }}
{% endif %}
{% if log.details and log.details.content %}

### Resource Contents
{% set res_path = log.params.get('File Path') or log.params.get('path') or log.params.get('Resource') %}
{{ render_resource(res_path, log.details.content) }}
{% endif %}
{% endfor %}
{% endif -%}

## Execution Summary

### Action Log
{% for log in report.action_logs %}

{% set description = log.params.get('Description') or log.params.get('description') %}
#### `{{ log.action_type.upper() }}`{% if description %} on "{{ description }}"{% endif %}
- **Status:** {{ log.status.value }}
{% if log.params %}
- **Params:** `{{ log.params }}`
{% endif %}
{{ render_action_details(log) }}
{% else %}
*(No actions were executed.)*
{% endfor %}
