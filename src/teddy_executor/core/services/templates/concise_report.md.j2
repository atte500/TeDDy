{#
  Unified template for the concise Markdown report.
  Renders both execution outcomes and pre-flight validation failures.

  NOTE ON WHITESPACE CONTROL:
  This template uses manual whitespace control (`-%}`) on blocks that are
  followed by blank lines. The Jinja2 `trim_blocks=True` setting only
  removes the *first* newline after a tag, not subsequent blank lines.
  The manual control is necessary to prevent extra newlines in the final
  rendered output when conditional sections are not rendered.
#}
{% macro render_resource(path, content) %}
**Resource:** `[{{ path | basename }}]({% if not path.startswith('/') %}/{% endif %}{{ path }})`
{{ content | fence }}text
{{ content }}
{{ content | fence }}
{% endmacro %}

{% macro render_action_details(log) %}
{% if log.details -%}
{% if log.details is mapping -%}
{% if log.details.get("error") -%}
- **Error:** {{ log.details.error }}
{% endif -%}
{% if log.details.get("original_details") -%}
- **Error:** {{ log.details.original_details }}
{% endif -%}
{% if log.details.get("return_code") is not none -%}
- **Return Code:** `{{ log.details.return_code }}`
{% endif -%}
{% if log.details.get("stdout") -%}
#### `stdout`
{{ log.details.stdout | trim | fence }}text
{{ log.details.stdout | trim }}
{{ log.details.stdout | trim | fence }}
{% endif -%}
{% if log.details.get("stderr") -%}
#### `stderr`
{{ log.details.stderr | trim | fence }}text
{{ log.details.stderr | trim }}
{{ log.details.stderr | trim | fence }}
{% endif -%}
{# Render generic details if no specific fields matched, but avoid rendering if it's just content #}
{% if not log.details.get("error") and not log.details.get("return_code") and not log.details.get("stdout") and not log.details.get("stderr") and not log.details.get("content") %}
- **Details:** `{{ log.details }}`
{% endif -%}
{% else -%}
- **Details:** `{{ log.details }}`
{% endif -%}
{% endif %}
{% endmacro %}
# Execution Report: {{ report.plan_title | default('Untitled Plan') }}

- **Overall Status:** {{ "Validation Failed" if report.run_summary.status.value == "VALIDATION_FAILED" else report.run_summary.status.value }}
- **Execution Start Time:** {{ format_datetime(report.run_summary.start_time) }}
- **Execution End Time:** {{ format_datetime(report.run_summary.end_time) }}
{% if report.validation_result %}
## Validation Errors
{% for error in report.validation_result %}
- {{ error }}
{% endfor %}
{% if report.failed_resources %}

### Resource Contents
{% for path, content in report.failed_resources.items() %}
{{ render_resource(path, content) }}
{% endfor %}
{% endif %}
{% endif -%}

{# Extract logs that should display resource content #}
{% set ns = namespace(content_logs=[]) %}
{% for log in report.action_logs %}
  {% if log.details and log.details is mapping and log.details.get('content') %}
    {# Include if it's a successful READ OR if it's a failed EDIT/CREATE #}
    {% if (log.action_type.lower() == 'read' and log.status.value == 'SUCCESS') or (log.status.value == 'FAILURE') %}
      {% set ns.content_logs = ns.content_logs + [log] %}
    {% endif %}
  {% endif %}
{% endfor -%}

{% if ns.content_logs %}
## Resource Contents
{% for log in ns.content_logs %}
{% set res_path = log.params.get('File Path') or log.params.get('Resource') or log.params.get('resource') or log.params.get('path') %}
{{ render_resource(res_path, log.details.content) }}
{% endfor %}
{% endif -%}

## Execution Summary

### Action Log
{% for log in report.action_logs %}

{% set description = log.params.get('Description') or log.params.get('description') %}

#### `{{ log.action_type.upper() }}`{% if description %} on "{{ description }}"{% endif %}

- **Status:**
  - {{ log.status.value }}
{% if log.params %}
- **Params:**
  {% for key, value in log.params.items() %}
  - **{{ key }}:** {{ value }}
  {% endfor %}
{% endif %}
{{ render_action_details(log) }}
{% else %}
*(No actions were executed.)*
{% endfor %}
