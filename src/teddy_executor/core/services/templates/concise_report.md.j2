{#
  Unified template for the concise Markdown report.
  Renders both execution outcomes and pre-flight validation failures.

  NOTE ON WHITESPACE CONTROL:
  This template uses manual whitespace control (`-%}`) on blocks that are
  followed by blank lines. The Jinja2 `trim_blocks=True` setting only
  removes the *first* newline after a tag, not subsequent blank lines.
  The manual control is necessary to prevent extra newlines in the final
  rendered output when conditional sections are not rendered.
#}
{% macro render_resource(path, content) %}
{% if path.startswith('http:') or path.startswith('https:') %}
### [{{ path }}]({{ path }})
{% else %}
### [{{ path }}]({% if not path.startswith('/') %}/{% endif %}{{ path }})
{% endif %}
{{ content | fence }}text
{{ content }}
{{ content | fence }}
{% endmacro %}

{% macro render_action_details(log) %}
{% if log.details -%}
{% if log.details is mapping -%}
{% if log.details.get("error") -%}
- **Error:** {{ log.details.error }}
{% endif -%}
{% if log.details.get("original_details") -%}
- **Error:** {{ log.details.original_details }}
{% endif -%}
{% if log.details.get("return_code") is not none -%}
- **Return Code:** `{{ log.details.return_code }}`
{% endif -%}
{% if log.details.get("stdout") -%}
#### `stdout`
{{ log.details.stdout | trim | fence }}text
{{ log.details.stdout | trim }}
{{ log.details.stdout | trim | fence }}
{% endif -%}
{% if log.details.get("stderr") -%}
#### `stderr`
{{ log.details.stderr | trim | fence }}text
{{ log.details.stderr | trim }}
{{ log.details.stderr | trim | fence }}
{% endif -%}
{# Render generic details if no specific fields matched, but avoid rendering if it's just content #}
{% if not log.details.get("error") and not log.details.get("return_code") and not log.details.get("stdout") and not log.details.get("stderr") and not log.details.get("content") %}
{% if log.action_type | upper not in ['INVOKE', 'RETURN'] %}
- **Details:** `{{ log.details }}`
{% endif -%}
{% endif -%}
{% else -%}
{% if log.action_type | upper not in ['INVOKE', 'RETURN'] %}
- **Details:** `{{ log.details }}`
{% endif -%}
{% endif -%}
{% endif %}
{% endmacro %}
# Execution Report: {{ report.plan_title | default('Untitled Plan') }}

- **Overall Status:** {{ "Validation Failed" if report.run_summary.status.value == "VALIDATION_FAILED" else report.run_summary.status.value }}
- **Execution Start Time:** {{ format_datetime(report.run_summary.start_time) }}
- **Execution End Time:** {{ format_datetime(report.run_summary.end_time) }}
{% if report.validation_result %}
## Validation Errors
{% for error in report.validation_result %}
- {{ error }}
{% endfor %}
{% if report.failed_resources %}

## Resource Contents
{% for path, content in report.failed_resources.items() %}
{{ render_resource(path, content) }}
{% endfor %}
{% endif %}
{% endif -%}

{# Extract logs that should display resource content #}
{% set ns = namespace(content_logs=[]) %}
{% for log in report.action_logs %}
  {% if log.details and log.details is mapping and log.details.get('content') %}
    {# Include if it's a successful READ OR if it's a failed EDIT/CREATE #}
    {% if (log.action_type.lower() == 'read' and log.status.value == 'SUCCESS') or (log.status.value == 'FAILURE') %}
      {% set ns.content_logs = ns.content_logs + [log] %}
    {% endif %}
  {% endif %}
{% endfor -%}

{% if ns.content_logs %}
## Resource Contents
{% for log in ns.content_logs %}
{% set res_path = log.params.get('File Path') or log.params.get('Resource') or log.params.get('resource') or log.params.get('path') %}
{{ render_resource(res_path, log.details.content) }}
{% endfor %}
{% endif -%}

## Action Log
{% for log in report.action_logs %}
{% set action_type = log.action_type.upper() %}
{% set params = log.params or {} %}
{% set target = '' %}

{# Determine Header Target #}
{% if action_type == 'EXECUTE' %}
  {% set target = '"' ~ (params.get('description') or params.get('Description') or 'Execute Command') ~ '"' %}
{% elif action_type == 'RESEARCH' %}
  {% set target = params.get('description') or params.get('Description') or 'Research' %}
{% elif action_type == 'CHAT_WITH_USER' %}
  {% set target = '' %}
{% else %}
  {# Use Markdown Link for CREATE/EDIT/READ #}
  {% set full_path = params.get('File Path') or params.get('file_path') or params.get('Resource') or params.get('resource') or params.get('path') or '' %}
  {# Check for URL schemes http and https #}
  {% if full_path.startswith('http:') or full_path.startswith('https:') %}
    {% set target = '[' ~ full_path ~ '](' ~ full_path ~ ')' %}
  {% else %}
    {% set target = '[' ~ (full_path | basename) ~ '](' ~ ('/' ~ full_path if not full_path.startswith('/') else full_path) ~ ')' %}
  {% endif %}
{% endif %}

{% if target %}
### `{{ action_type }}`: {{ target }}
{% else %}
### `{{ action_type }}`
{% endif %}
- **Status:** {{ log.status.value }}
{% if action_type in ['CREATE', 'EDIT'] %}
  {% set path_val = params.get('File Path') or params.get('file_path') or params.get('path') %}
  {% if path_val %}
- **File Path:** `{{ path_val }}`
  {% endif %}
{% endif %}

{# Params Rendering - Flattened #}
{% if action_type == 'EXECUTE' %}
  {% set outcome = params.get('expected_outcome') or params.get('Expected Outcome') %}
  {% if outcome %}
- **Expected outcome:** {{ outcome }}
  {% endif %}

  {% set cmd = params.get('command') or params.get('cmd') %}
  {% if cmd %}

- **Command:** {% if '\n' in cmd %}
{{ '\n' }}{{ cmd | fence }}shell
{{ cmd }}
{{ cmd | fence }}
{% else %}`{{ cmd }}`{% endif %}
  {% endif %}

{% else %}
{# Generic Params for CREATE, EDIT, READ, RESEARCH etc #}
{% if params %}
  {% for key, value in params.items() %}
    {% set k_lower = key.lower() %}
    {# Filter out standard huge fields #}
    {% set ignored_keys = ['content', 'find', 'replace', 'edits'] %}
    {# For RESEARCH, hide description (in header) and queries (in body) #}
    {% if action_type == 'RESEARCH' %}
        {% set ignored_keys = ignored_keys + ['description', 'queries'] %}
    {% endif %}
    {# For RETURN/INVOKE, hide message and resources (handled separately) #}
    {% if action_type in ['RETURN', 'INVOKE'] %}
        {% set ignored_keys = ignored_keys + ['message', 'handoff_resources', 'handoff resources'] %}
    {% endif %}
    {# For CHAT_WITH_USER, hide the AI prompt #}
    {% if action_type == 'CHAT_WITH_USER' %}
        {% set ignored_keys = ignored_keys + ['prompt'] %}
    {% endif %}
    {% if k_lower not in ignored_keys %}
      {# Normalize key to Title Case (simple approximation or explicit mapping) #}
      {% set display_key = key.replace('_', ' ').title() %}
      {# Skip path params in body since they are in header #}
      {% if k_lower not in ['file path', 'file_path', 'resource', 'path'] %}
- **{{ display_key }}:** {{ value }}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endif %}
{% endif %}

{% if action_type == 'RESEARCH' and log.details and log.details.results %}
{% for result in log.details.results %}

**Query:** `{{ result.query }}`
{% for item in result.search_results %}
[{{ item.title }}]({{ item.url }})
```Snippet
{{ item.snippet }}
```
{% endfor %}
{% endfor %}
{% endif %}

{% if action_type == 'CHAT_WITH_USER' %}
{% if log.details and log.details.response %}

#### User Response
{{ log.details.response | fence }}text
{{ log.details.response }}
{{ log.details.response | fence }}
{% endif %}
{% elif action_type in ['RETURN', 'INVOKE'] %}
  {% set resources = params.get('handoff_resources') or params.get('Handoff Resources') %}
  {% if resources %}
- **Handoff Resources:**
{{ resources | join('\n') | fence }}text
{{ resources | join('\n') }}
{{ resources | join('\n') | fence }}
  {% endif %}
  {% set msg = params.get('message') or params.get('Message') %}
  {% if msg %}

{{ msg }}
  {% endif %}
  {{ render_action_details(log) }}
{% elif action_type != 'RESEARCH' %}
{{ render_action_details(log) }}
{% endif %}
{% else %}
*(No actions were executed.)*
{% endfor %}
